<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Osman Shop Charer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary-color: #4a148c; --secondary-color: #5e35b1; --success-color: #4CAF50; --pending-color: #ff9800; --danger-color: #f44336; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px 20px 80px 20px; }
        .container { max-width: 800px; margin: auto; }
        h2 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top: 0; }
        #auth-section, .management-section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        input, select, button, textarea { width: 100%; box-sizing: border-box; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; }
        button { cursor: pointer; border: none; font-weight: bold; color: white; background-color: var(--success-color); }
        textarea { min-height: 100px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { flex: 1; padding: 15px 5px; color: #757575; border: none; background: transparent; cursor: pointer; font-size: 0.8em; white-space: nowrap; }
        .nav-item.active { color: var(--primary-color); font-weight: bold; border-top: 3px solid var(--primary-color); }
        .management-section { display: none; }
        .management-section.active { display: block; }
        .list-item { background: #fdfdff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; word-wrap: break-word; }
        .list-item p { margin: 5px 0; }
        .item-actions { margin-top: 15px; display: flex; gap: 10px; }
        .item-actions button { font-size: 0.9em; padding: 8px 12px; width: auto; }
        .plan-entry { border: 1px dashed #ddd; padding: 15px; margin-bottom: 10px; background: #fafafa; border-radius: 5px; }
        #logout-btn { background-color: var(--danger-color); }
        .form-container { display:none; margin-top:20px; }
        .search-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-container input { width: 70%; margin-bottom: 0; }
        .search-container button { width: 30%; margin-bottom: 0; }
        .loader-container { display: flex; justify-content: center; align-items: center; padding: 50px; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="container">
    <div id="auth-section"><h2>Admin Login</h2><input type="email" id="admin-email" placeholder="Email"><input type="password" id="admin-password" placeholder="Password"><button id="admin-login-btn">Login</button></div>
    <div id="admin-section" style="display:none;">
        <div id="deposit-management" class="management-section"><h2>Deposit Requests</h2><div id="admin-deposit-list"></div></div>
        <div id="order-management" class="management-section"><h2>All Orders</h2><div id="admin-order-list"></div></div>
        <div id="user-management" class="management-section"><h2>Users</h2><div class="search-container"><input type="email" id="user-search-email" placeholder="Search by email"><button id="user-search-btn">Search</button></div><div id="admin-user-list"></div></div>
        <div id="notification-management" class="management-section">
            <h2>Send Notification</h2>
            <div id="notification-form">
                <label for="notification-recipient">Recipient:</label>
                <select id="notification-recipient"><option value="all">All Users</option><option value="specific">Specific User</option></select>
                <input type="email" id="notification-user-email" placeholder="Enter user's email" style="display:none; margin-top: 10px;">
                <label for="notification-title">Title:</label>
                <input type="text" id="notification-title" placeholder="Notification Title">
                <label for="notification-message">Message:</label>
                <textarea id="notification-message" placeholder="Write your message here..."></textarea>
                <button id="send-notification-btn">Send Notification</button>
            </div>
        </div>
        <div id="product-management" class="management-section"><h2>Products</h2><div id="admin-product-list"></div><button id="show-add-product-btn">+ Add Product</button><div id="product-form-container"></div></div>
        <div id="profile-management" class="management-section"><h2>Profile</h2><p id="admin-user-email"></p><button id="logout-btn">Logout</button></div>
    </div>
</div>
<div id="admin-nav" class="bottom-nav" style="display: none;">
    <button class="nav-item" data-target="deposit-management">Deposits</button>
    <button class="nav-item" data-target="order-management">Orders</button>
    <button class="nav-item" data-target="user-management">Users</button>
    <button class="nav-item" data-target="notification-management">Notify</button>
    <button class="nav-item" data-target="product-management">Products</button>
    <button class="nav-item" data-target="profile-management">Profile</button>
</div>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyAFr74mAqFDn_mxAtCGhKX0Tld4TAcep5U", authDomain: "osman-topup-career.firebaseapp.com", projectId: "osman-topup-career", storageBucket: "osman-topup-career.appspot.com", messagingSenderId: "907318077551", appId: "1:907318077551:web:acb76049a46d3ab1f1059a" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const ADMIN_UIDS = ["g37yEOxRrSRoLIyPZdHCaIAoAwc2"]; 
    
    document.addEventListener('DOMContentLoaded', () => {
        const authSection = document.getElementById('auth-section');
        const adminSection = document.getElementById('admin-section');
        const adminNav = document.getElementById('admin-nav');
        const loadingSpinner = `<div class="loader-container"><div class="loader"></div></div>`;

        function showSection(targetId) {
            document.querySelectorAll('.management-section').forEach(s => s.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`.nav-item[data-target="${targetId}"]`).classList.add('active');
        }

        auth.onAuthStateChanged(user => {
            if (user && ADMIN_UIDS.includes(user.uid)) {
                authSection.style.display = 'none';
                adminSection.style.display = 'block';
                adminNav.style.display = 'flex';
                document.getElementById('admin-user-email').innerText = `Logged in: ${user.email}`;
                loadInitialData();
                showSection('deposit-management');
            } else {
                authSection.style.display = 'block';
                adminSection.style.display = 'none';
                adminNav.style.display = 'none';
            }
        });

        function loadInitialData() {
            loadDepositsForAdmin();
            loadOrdersForAdmin();
            loadUsersForAdmin();
            loadProductsForAdmin();
        }

        document.getElementById('admin-login-btn').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById('admin-email').value, document.getElementById('admin-password').value).catch(err => alert(err.message)));
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
        document.querySelectorAll('.nav-item').forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.target)));
        document.getElementById('user-search-btn').addEventListener('click', () => {
            const email = document.getElementById('user-search-email').value.trim();
            loadUsersForAdmin(email);
        });

        async function loadDepositsForAdmin() {
            const list = document.getElementById('admin-deposit-list');
            list.innerHTML = loadingSpinner;
            try {
                const snap = await db.collection('deposits').where('status', '==', 'verification_pending').orderBy('createdAt', 'desc').get();
                if (snap.empty) { list.innerHTML = '<p>No pending deposit requests.</p>'; return; }
                list.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="list-item"><p><strong>User:</strong> ${d.userEmail}</p><p><strong>Amount:</strong> ${d.amount} TK</p><p><strong>Method:</strong> ${d.paymentMethod}</p><p><strong>TrxID:</strong> ${d.transactionId}</p><p><strong>Status:</strong> ${d.status}</p><div class="item-actions"><button onclick="approveDeposit('${doc.id}','${d.userId}',${d.amount})">Approve</button><button onclick="rejectRequest('${doc.id}', 'deposits')" style="background:var(--danger-color)">Reject</button></div></div>`;
                }).join('');
            } catch (error) {
                console.error("Error loading deposits:", error);
                list.innerHTML = '<p>Error loading deposit requests. You may need to create a Firestore index. Check console for a link.</p>';
            }
        }

        window.approveDeposit = async (depositId, userId, amount) => {
            if (!confirm(`Approve ${amount} TK for this user?`)) return;
            const userRef = db.collection('users').doc(userId);
            const depositRef = db.collection('deposits').doc(depositId);
            try {
                await db.runTransaction(async t => {
                    const userDoc = await t.get(userRef);
                    if (!userDoc.exists) throw "User not found! Please create their document in the 'users' collection first.";
                    t.update(depositRef, { status: 'approved' });
                    t.update(userRef, { balance: firebase.firestore.FieldValue.increment(amount) });
                });
                alert('Deposit approved and balance updated!');
                loadDepositsForAdmin();
            } catch (e) { alert('Error: ' + e); }
        };

        window.rejectRequest = async (docId, collection) => {
            if (!confirm(`Are you sure you want to reject this request?`)) return;
            const docRef = db.collection(collection).doc(docId);
            try {
                const doc = await docRef.get();
                if (!doc.exists) throw "Document not found!";
                const data = doc.data();
                if (collection === 'orders' && data.paidWith === 'balance') {
                    const userRef = db.collection('users').doc(data.userId);
                    await db.runTransaction(async t => {
                        const userDoc = await t.get(userRef);
                        if (!userDoc.exists) throw "User for refund not found!";
                        t.update(userRef, { balance: firebase.firestore.FieldValue.increment(data.amount) });
                        t.update(docRef, { status: 'Rejected' });
                    });
                    alert('Order rejected and balance has been refunded to the user.');
                } else {
                    await docRef.update({ status: 'Rejected' });
                    alert('Request rejected.');
                }
                if (collection === 'deposits') loadDepositsForAdmin();
                if (collection === 'orders') loadOrdersForAdmin();
            } catch (error) {
                console.error("Error rejecting request: ", error);
                alert("An error occurred: " + error.message);
            }
        };
        
        async function loadUsersForAdmin(searchEmail = '') {
            const list = document.getElementById('admin-user-list');
            list.innerHTML = loadingSpinner;
            let query = db.collection('users');
            if (searchEmail) {
                query = query.where('email', '==', searchEmail);
            } else {
                query = query.orderBy('createdAt', 'desc');
            }
            const snap = await query.get();
            list.innerHTML = snap.docs.map(doc => {
                const u = doc.data();
                return `<div class="list-item"><p><strong>Email:</strong> ${u.email}</p><p><strong>Balance:</strong> ${u.balance || 0} TK</p><div class="item-actions"><button onclick="editBalance('${doc.id}', ${u.balance || 0})">Edit Balance</button></div></div>`;
            }).join('') || '<p>No users found.</p>';
        }

        window.editBalance = async (userId, currentBalance) => {
            const newBalance = prompt("Enter new balance:", currentBalance);
            if (newBalance !== null && !isNaN(newBalance)) {
                await db.collection('users').doc(userId).update({ balance: parseFloat(newBalance) });
                alert('Balance updated!');
                loadUsersForAdmin(document.getElementById('user-search-email').value.trim());
            }
        };

        const productFormContainerHTML = `<div id="product-form" class="form-container"><h3 id="product-form-title"></h3><input type="hidden" id="edit-product-id"><input type="text" id="product-name" placeholder="Product Name"><input type="url" id="image-url" placeholder="Image URL"><h4>Plans</h4><div id="plans-editor"></div><button id="add-plan-btn" type="button" style="background-color:var(--secondary-color);">+ Add Plan</button><button id="save-product-btn">Save Product</button><button id="cancel-product-btn" type="button" style="background:#9e9e9e;">Cancel</button></div>`;
        document.getElementById('product-form-container').innerHTML = productFormContainerHTML;
        
        async function loadProductsForAdmin() {
            const list = document.getElementById('admin-product-list');
            list.innerHTML = loadingSpinner;
            document.getElementById('show-add-product-btn').style.display = 'block';
            document.getElementById('product-form').style.display = 'none';
            const snap = await db.collection('products').orderBy('name').get();
            list.innerHTML = snap.docs.map(doc => `<div class="list-item"><p><strong>${doc.data().name}</strong></p><div class="item-actions"><button onclick="editProduct('${doc.id}')">Edit</button><button onclick="deleteProduct('${doc.id}')" style="background:var(--danger-color)">Delete</button></div></div>`).join('') || '<p>No products found.</p>';
        }

        window.editProduct = async (id) => { const doc = await db.collection('products').doc(id).get(); if (doc.exists) showProductForm(true, id, doc.data()); };
        window.deleteProduct = async (id) => { if (confirm('Are you sure you want to delete this product?')) { await db.collection('products').doc(id).delete(); loadProductsForAdmin(); } };
        
        function showProductForm(isEdit, id, data = {}) {
            document.getElementById('product-form-title').innerText = isEdit ? `Edit: ${data.name}` : 'Add New Product';
            document.getElementById('edit-product-id').value = id || '';
            document.getElementById('product-name').value = data.name || '';
            document.getElementById('image-url').value = data.imageUrl || '';
            const editor = document.getElementById('plans-editor');
            editor.innerHTML = '';
            if (data.plans) data.plans.forEach(p => addPlanEntry(p));
            document.getElementById('product-form').style.display = 'block';
            document.getElementById('show-add-product-btn').style.display = 'none';
            document.getElementById('admin-product-list').style.display = 'block'; // Corrected from 'none'
        }

        function addPlanEntry(plan = {}) {
            const editor = document.getElementById('plans-editor');
            const entry = document.createElement('div');
            entry.className = 'plan-entry';
            entry.innerHTML = `<input value="${plan.name || ''}" placeholder="Plan Name"><input type="number" value="${plan.price || ''}" placeholder="Price"><select><option value="true" ${plan.stock !== false ? 'selected' : ''}>In Stock</option><option value="false" ${plan.stock === false ? 'selected' : ''}>Out of Stock</option></select><button type="button" onclick="this.parentElement.remove()" style="background:var(--danger-color)">Remove</button>`;
            editor.appendChild(entry);
        }
        
        document.getElementById('show-add-product-btn').addEventListener('click', () => showProductForm(false));
        document.getElementById('add-plan-btn').addEventListener('click', () => addPlanEntry());
        document.getElementById('cancel-product-btn').addEventListener('click', () => loadProductsForAdmin());
        document.getElementById('save-product-btn').addEventListener('click', async () => {
            const id = document.getElementById('edit-product-id').value;
            const plans = [...document.querySelectorAll('#plans-editor .plan-entry')].map(e => ({ name: e.children[0].value, price: parseFloat(e.children[1].value) || 0, stock: e.children[2].value === 'true' }));
            const data = { name: document.getElementById('product-name').value, imageUrl: document.getElementById('image-url').value, plans };
            if (!data.name) return alert('Product name is required.');
            if (id) { await db.collection('products').doc(id).update(data); } else { await db.collection('products').add(data); }
            loadProductsForAdmin();
        });

        async function loadOrdersForAdmin() {
            const list = document.getElementById('admin-order-list');
            list.innerHTML = loadingSpinner;
            const snap = await db.collection('orders').orderBy('createdAt', 'desc').get();
            if (snap.empty) { list.innerHTML = '<p>No orders found.</p>'; return; }
            list.innerHTML = snap.docs.map(doc => {
                const o = doc.data();
                let status = o.status.replace(/_/g, ' ');
                status = status.charAt(0).toUpperCase() + status.slice(1);
                const verificationDetails = status === 'Verification pending' ? `<p><strong>Method:</strong> ${o.paymentMethod}</p><p><strong>TrxID:</strong> ${o.transactionId}</p>` : '';
                return `<div class="list-item"><p><strong>Product:</strong> ${o.productName} (${o.packageName})</p><p><strong>Customer:</strong> ${o.userEmail}</p><p><strong>Paid With:</strong> ${o.paidWith || o.paymentMethod || 'N/A'}</p>${verificationDetails}<p><strong>Status:</strong> ${status}</p><div class="item-actions">${o.status !== 'Completed' && o.status !== 'Rejected' ? `<button onclick="updateOrderStatus('${doc.id}','Completed')">Complete</button>` : ''}${o.status !== 'Rejected' && o.status !== 'Completed' ? `<button onclick="updateOrderStatus('${doc.id}', 'Rejected')" style="background:var(--danger-color)">Reject</button>` : ''}</div></div>`;
            }).join('');
        }

        window.updateOrderStatus = async (id, status) => {
            if (status === 'Rejected') {
                rejectRequest(id, 'orders');
                return;
            }
            if (confirm(`Change status to "${status}"?`)) {
                await db.collection('orders').doc(id).update({ status });
                loadOrdersForAdmin();
            }
        };

        const recipientSelect = document.getElementById('notification-recipient');
        const userEmailInput = document.getElementById('notification-user-email');
        const sendBtn = document.getElementById('send-notification-btn');
        recipientSelect.addEventListener('change', () => { userEmailInput.style.display = recipientSelect.value === 'specific' ? 'block' : 'none'; });
        sendBtn.addEventListener('click', async () => {
            const recipientType = recipientSelect.value;
            const title = document.getElementById('notification-title').value.trim();
            const message = document.getElementById('notification-message').value.trim();
            const userEmail = document.getElementById('notification-user-email').value.trim();
            if (!title || !message) { return alert('Title and message are required.'); }
            sendBtn.disabled = true; sendBtn.textContent = 'Sending...';
            try {
                let recipient = 'all';
                if (recipientType === 'specific') {
                    if (!userEmail) throw new Error('User email is required.');
                    const userQuery = await db.collection('users').where('email', '==', userEmail).limit(1).get();
                    if (userQuery.empty) throw new Error('User with this email not found.');
                    recipient = userQuery.docs[0].id;
                }
                await db.collection('notifications').add({ title, message, recipient, createdAt: new Date() });
                alert('Notification sent successfully!');
                document.getElementById('notification-title').value = '';
                document.getElementById('notification-message').value = '';
                document.getElementById('notification-user-email').value = '';
            } catch (error) { alert('Error: ' + error.message); } 
            finally { sendBtn.disabled = false; sendBtn.textContent = 'Send Notification'; }
        });
    });
</script>
</body>
</html>